@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "List";
}
<h2>List</h2>
<div class="container-fluid desh">
    <!-- Page Content -->
    <div id="page-wrapper">
        <div class="col-lg-12">
            <div class="box box-info">
                <div class="box-header with-border">
                    <ul class="nav">
                        <li style="font-size:20px">
                            Received Applications
                        </li>
                        <li class="pull-right"><a href="@Url.Action("ForesterDashboard", "ForesterAction")"><i class="fa fa-exchange"></i> Back To DashBoard </a></li>
                    </ul>
                </div>
                <div class="row">
                    <div class="col-md-12" style="padding-right:0">
                        <div class="panel with-nav-tabs panel-default">
                            <div class="panel-heading">
                                <ul class="nav nav-tabs">
                                    <li class="active"><a href="#tab1pdefault" data-toggle="tab"><i class="fa fa-star fa-fw"></i> My Actions</a></li>
                                    <li class=""><a href="#tab2pdefault" data-toggle="tab"><i class="fa fa-user fa-fw"></i> Pending Requests</a></li>
                                    <li class=""><a href="#tab3pdefault" data-toggle="tab"><i class="fa fa-comment fa-fw"></i>To Be Assign</a></li>
                                </ul>
                            </div>
                            <div class="panel-body">
                                <div class="tab-content">
                                    <div class="tab-pane fade active in tbl-scroll" id="tab1pdefault">
                                        <div class="panel-body">
                                            <div class="table-responsive request-id">
                                                <table class="table table-striped table-bordered table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Request Id</th>
                                                            <th>Request Type</th>
                                                            <th>Application Date</th>
                                                            <th>Action Taken</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @if (ViewBag.NOCMyAction != null)
                                                        {
                                                            foreach (var item in ViewBag.NOCMyAction as IEnumerable<FMDSS.Models.CitizenService.PermissionServices.NocList>)
                                                            {
                                                                <tr onclick="reqdetail('@item.RequestId','@item.StatusId')">
                                                                    <td>
                                                                        @Html.DisplayFor(model => item.RequestId)
                                                                    </td>
                                                                    <td>
                                                                        @Html.DisplayFor(model => item.NocType)
                                                                    </td>
                                                                    <td>
                                                                        @Html.DisplayFor(model => item.ReqDate)
                                                                    </td>
                                                                    <td>
                                                                        @Html.DisplayFor(model => item.Status)
                                                                    </td>
                                                                </tr>
                                                            }
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade tbl-scroll" id="tab2pdefault">
                                        <div class="panel-body">
                                            <div class="table-responsive">
                                                <table class="table table-striped table-bordered table-hover table-responsive" id="dataTables-example">
                                                    <thead>
                                                        <tr>
                                                            <th>Transaction Id</th>
                                                            <th>Service Type</th>
                                                            <th>Application Date</th>
                                                            <th>Application Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @if (ViewBag.NOCPending != null)
                                                        {
                                                            foreach (var item in ViewBag.NOCPending as IEnumerable<FMDSS.Models.CitizenService.PermissionServices.NocList>)
                                                            {
                                                                <tr onclick="reqdetail('@item.RequestId','@item.StatusId')">
                                                                    <td>
                                                                        @Html.DisplayFor(model => item.RequestId)
                                                                    </td>
                                                                    <td>
                                                                        @Html.DisplayFor(model => item.NocType)
                                                                    </td>
                                                                    <td>
                                                                        @Html.DisplayFor(model => item.ReqDate)
                                                                    </td>
                                                                    <td>
                                                                        @Html.DisplayFor(model => item.Status)
                                                                    </td>
                                                                </tr>
                                                            }
                                                        }
                                                        <tr></tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade tbl-scroll" id="tab3pdefault">
                                        <div class="panel-body">
                                            <div class="table-responsive">
                                                <table class="table table-striped table-bordered table-hover table-responsive" id="dataTables-example">
                                                    <thead>
                                                        <tr>
                                                            <th>Transaction Id</th>
                                                            <th>Service Type</th>
                                                            <th>Application Date</th>
                                                            @*<th style="display:none">Transaction</th>*@
                                                            <th>Application Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @if (ViewBag.NOCToBeAssign != null)
                                                        {
                                                            foreach (var item in ViewBag.NOCToBeAssign as IEnumerable<FMDSS.Models.CitizenService.PermissionServices.NocList>)
                                                            {
                                                                <tr onclick="reqdetail('@item.RequestId','@item.StatusId')">
                                                                    <td>
                                                                        @Html.DisplayFor(model => item.RequestId)
                                                                    </td>
                                                                    <td>
                                                                        @Html.DisplayFor(model => item.NocType)
                                                                    </td>
                                                                    <td>
                                                                        @Html.DisplayFor(model => item.ReqDate)
                                                                    </td>
                                                                    <td>
                                                                        @Html.DisplayFor(model => item.Status)
                                                                    </td>
                                                                </tr>
                                                            }
                                                        }
                                                        <tr></tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    #myModalDfo .modal-dialog {
        width: 900px;
        margin: 30px auto;
    }

    .error {
        border-color: red;
    }
</style>
<div class="modal" id="myModalDfo" tabindex="-1" role="dialog" aria-hidden="false" style="display:none;">
    <div class="modal-dialog mdw">
        <div class="modal-content" style="height:680px;">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title" id="myModalLabel">
                    Request Details
                    <button type="button" name="btnprint" id="btnprint" onclick="Print();" class="btn btn-default pull-right">
                        <i class="fa fa-print"></i> Print
                    </button>
                </h4>
            </div>
            <div id="divPrint" class="modal-body tbl-scroll divPrintone">
                <!-- From URL Get -->
                <table class="table table-striped table-bordered table-hover">
                    <tbody id="tbReqDetail"></tbody>
                </table>
            </div>
            <br />

            @using (Html.BeginForm("AssignReq", "NOC", FormMethod.Post, new { @id = "formAssign" }))
            {
                <input type="hidden" id="ReqId" name="ReqId" value="" />
                <input type="hidden" id="ReqStatus" name="ReqStatus" value="" />
                <input type="hidden" id="cmd" name="cmd" value="" />
                <div class="row assign" style="text-align:center; display:none;">
                    <div class="col-lg-6">
                        <div class="form-group">
                            <label>Designation:<span class="mandatory">*</span></label>
                            <select id="dropDesignation" name="dropDesignation" class="form-control"></select>
                            @*@Html.DropDownList("dropDesignation", (IEnumerable<SelectListItem>)ViewBag.OfficerDesignation, "--Select--", new { @class = "form-control" })*@
                            <div id="errdropDesignation" style="display:none" class="alert-danger1">Designation is Required.</div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="form-group">
                            <label>Forest Officers:<span class="mandatory">*</span></label>
                            @Html.DropDownList("dropForester", new SelectList(string.Empty, "Value", "Text"), "--Select--", new { @class = "form-control" })
                            <div id="errdropForester" style="display:none" class="alert-danger1">Forest Officers is Required.</div>
                        </div>
                    </div>
                    <div class="col-lg-12"></div>
                    <br />
                </div>
                <div class="modal-footer assign" style="display:none;">
                    <div id="btn" class="col-lg-12">
                        <button id="btnForward" type="button" class="btn btn-success forward" name="Command" value="Forward">
                            <i class="fa fa-check"></i> Assign
                        </button>
                        <button name="button" class="btn btn-danger btnCancel" type="button" value="Cancel" data-dismiss="modal" style="width: auto">
                            <i class="fa fa-times fa-fw"></i> Close
                        </button>
                    </div>
                </div>

                <div class="review" style="display:none;">
                    <div class="col-lg-6" style="display:none;">
                        <div class="form-group">
                            <label>Reason:<span class="mandatory"> </span></label>
                            @Html.TextArea("Reason", new { @class = "form-control" })
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="form-group">
                            <label>Comment:<span class="mandatory">*</span></label>
                            <textarea class="form-control" id="txtAreaComment" name="txtAreaComment"></textarea>
                        </div>
                    </div>
                    <div id="divDoc" class="col-lg-6">
                        <div class="form-group">
                            <label>Inspection/Verification Report:(pdf file 2 MB)<span class="mandatory">*</span><span id="SDoc" style="display:none;" class="mandatory">Inspection/Verification Report</span></label>
                            <input class="form-control" id="Survey_Doc" name="Survey_Doc" type="file">
                        </div>
                    </div>
                    <div class="col-lg-12"></div>
                    <div class="btn-padd">
                        <div id="btn" class="col-lg-12">
                            <button type="button" class="btn btn-success" name="Command" id="btnReview">
                                <i class="fa fa-check"></i>Approve
                            </button>
                            <button type="button" class="btn btn-warning" name="Command" value="4" id="btn_Reasign">
                                <i class="fa fa-circle-o-notch fa-fw"></i>Reasign
                            </button>
                            <button type="button" class="btn btn-danger" name="Command" value="3" id="btn_Reject">
                                <i class="fa fa-circle-o-notch fa-fw"></i>Reject
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<script type="text/javascript">
    var origin = document.location.origin;
    function reqdetail(reqId, reqStatus) {
        $.ajax({
            type: 'GET',
            url: origin + '/Noc/getDetail',
            dataType: 'json',
            data: { requestId: reqId },
            success: function (data) {
                $.each(data, function (i, item) {
                    var reqData = "";
                    for (var key in item) {
                        //$('#id').val() == '0' || $('#id').val() == '' || $('#id').val() == 'undefined' || $('#id').val() == null
                        if (item[key] != null && item[key] != '' && item[key] != 'undefined' && item[key] != '0' && item[key] != 'null') {
                            var str = item[key].toString();
                            if (str.indexOf('~/') >= 0) {
                                var lnk = '<a href="' + str.replace('~', origin) + '" target="_blank"> Download </a>';
                                reqData += "<tr><td>" + key + "</td><td>" + lnk + "</td></tr>";
                            } else {
                                reqData += "<tr><td>" + key + "</td><td>" + item[key] + "</td></tr>";
                            }
                        }
                    }
                    $('#tbReqDetail').empty().append(reqData);
                    $('#myModalDfo').show();

                    $('#ReqId').val(reqId);
                    $('#ReqStatus').val(reqStatus);

                    $('.error').each(function () { $(this).removeClass('error'); })
                    ShowReq(reqStatus);
                });
            },
            error: function (ex) {
                alert('Failed to retrieve Request Data. ' + ex);
            }
        });
    }

    function ShowReq(reqStatus) {
        if (reqStatus == 0 || reqStatus == 1) {
            $('.review').hide();
            $('.assign').show();
            $.ajax({
                url: origin + '/Noc/GetOfficers',
                type: 'POST',
                dataType: 'json',
                success: function (data) {
                    $('#dropDesignation').empty();
                    $('#dropDesignation').append("<option value='0'>--Select--</option>");
                    $.each(data, function (index, optiondata) {
                        $('#dropDesignation').append("<option value='" + optiondata.Value + "'>" + optiondata.Text + "</option>");
                    });
                }
            });

        } else if (reqStatus == 11) {
            $('.assign').hide();
            $('.review').show();
            $('#btnReview').html('<i class="fa fa-check"></i> Review');
        } else if (reqStatus == 7) {
            $('.assign').hide();
            $('.review').show();
            $('#btnReview').html('<i class="fa fa-check"></i> Approve');
        }
    }

    $(document).ready(function () {
        $('#btnprint').click(function (e) {
            var divContents = $("#divPrint").html();
            var frame1 = $('<iframe />');
            frame1[0].name = "frame1";
            $("body").append(frame1);
            var frameDoc = frame1[0].contentWindow ? frame1[0].contentWindow : frame1[0].contentDocument.document ? frame1[0].contentDocument.document : frame1[0].contentDocument;
            frameDoc.document.open();
            frameDoc.document.write('<html><head><link href="../css/bootstrap.min.css" rel="stylesheet" />');
            frameDoc.document.write('<link href="../css/mobile.css" rel="stylesheet" />');
            frameDoc.document.write('<link href="../css/dashboard/main.css" rel="stylesheet" />');
            frameDoc.document.write('<link href="../css/dashboard/dashboard.css" rel="stylesheet" />');
            frameDoc.document.write('<link href="../css/dashboard/font-awesome.min.css" rel="stylesheet" />');
            frameDoc.document.write('</head><body>');
            frameDoc.document.write(divContents);
            frameDoc.document.write('</body></html>');
            frameDoc.document.close();
            setTimeout(function () {
                window.frames["frame1"].focus();
                window.frames["frame1"].print();
                frame1.remove();
            }, 500);
        });

        function checkEle(id) {            
            var Ele = $('#' + id);
            var eleVal = Ele.val();
            if (eleVal != null && eleVal.replace('0', '').trim().length > 0) {
                Ele.removeClass('error');
            }
            else {
                Ele.addClass('error');
            }
            $('#' + id).bind("change", function () {
                checkEle(id);
            });
        } 
        function finalCheck(cmdVal, ids) {
            $('.error').each(function () { $(this).removeClass('error'); })
            for (i in ids) {
                checkEle(ids[i]);
            }
            $('#cmd').val(cmdVal);
            if (!($('.error').length > 0)) {
                $('#formAssign').submit();
            }
        }
        $('#btnForward').on('click', function () {
            finalCheck('11', ['dropDesignation', 'dropForester']);
        });
        $('#btnReview').on('click', function () {
            if ($('#ReqStatus').val() == "7") {
                finalCheck('2', ['txtAreaComment', 'Survey_Doc']);
            } else {
                finalCheck('7', ['txtAreaComment', 'Survey_Doc']);
            }
        });
        $('#btn_Reasign').on('click', function () {
            finalCheck('6', ['txtAreaComment']); 
        });
        $('#btn_Reject').on('click', function () {
            finalCheck('3', ['txtAreaComment']);           
        });
        $('.close').on('click', function () {
            $('#myModalDfo').hide();
        });

        $('.btnCancel').on('click', function () {
            $('#myModalDfo').hide();
        });
        $('#dropDesignation').change(function (e) {
            $("#dropForester").empty();
            $("#dropForester").append('<option value="-1">--Select--</option>');
            $.ajax({
                type: 'POST',
                url: origin + '/ForesterAction/getForestOfficer',
                dataType: 'json',
                data: { designation: $("#dropDesignation").val() },
                success: function (states) {
                    $.each(states, function (i, block) {
                        $("#dropForester").append('<option value="' + block.Value + '">' + block.Text + '</option>');
                    });
                },
                error: function (ex) {
                    alert('Failed to retrieve states.' + ex);
                }
            });
        });
    });
</script>
